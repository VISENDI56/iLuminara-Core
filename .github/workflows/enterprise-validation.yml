name: Enterprise Validation Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight

env:
  VALIDATION_LEVEL: enterprise
  FAIL_ON_WARNINGS: false

jobs:
  validate:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        os: [ubuntu-latest]
        node-version: [18.x, 20.x]

    steps:
      - uses: actions/checkout@v4

      - name: Setup environment
        run: |
          echo "Setting up validation environment..."

          # Install security tools
          sudo apt-get update
          sudo apt-get install -y shellcheck jq tree

          # Install Trivy for security scanning
          wget https://github.com/aquasecurity/trivy/releases/download/v0.45.1/trivy_0.45.1_Linux-64bit.deb
          sudo dpkg -i trivy_0.45.1_Linux-64bit.deb

          # Install dependency checkers
          pip3 install safety bandit

          # Create validation directory
          mkdir -p ./validation/reports

      - name: Run Basic Validation
        id: basic-validation
        run: |
          echo "Starting basic validation..."

          # Tech stack detection
          echo "Tech Stack:"
          [ -f "package.json" ] && echo "- Node.js"
          [ -f "requirements.txt" ] && echo "- Python"
          [ -f "pom.xml" ] && echo "- Java"
          [ -f "go.mod" ] && echo "- Go"
          [ -f "Dockerfile" ] && echo "- Docker"

          # Git status
          echo "Git Status:"
          git status --short

          # Count files
          echo "File Statistics:"
          find . -type f -not -path "./node_modules/*" -not -path "./.git/*" | wc -l | xargs echo "Total files:"

          # Security scan with Trivy
          echo "Running security scan..."
          trivy fs --severity HIGH,CRITICAL --format json --output ./validation/reports/security_scan.json . || true

      - name: Tech Stack Specific Validation
        run: |
          echo "Running tech stack specific checks..."

          # Node.js projects
          if [ -f "package.json" ]; then
            echo "Validating Node.js project..."
            npm ci --audit
            npm audit --audit-level=high || true
            npm run test --if-present || echo "Tests not configured"
          fi

          # Python projects
          if [ -f "requirements.txt" ]; then
            echo "Validating Python project..."
            pip install -r requirements.txt
            python -m pytest --tb=short -q || echo "Tests not configured"

            # Security check
            safety check || true
          fi

      - name: Generate Validation Report
        run: |
          echo "Generating validation report..."

          cat > ./validation/reports/validation_report.md << 'EOREPORT'
# Enterprise Validation Report

## Summary
- **Date:** $(date)
- **Repository:** ${{ github.repository }}
- **Branch:** ${{ github.ref }}
- **Commit:** ${{ github.sha }}

## Security Status
$(if [ -f "./validation/reports/security_scan.json" ]; then
  echo "Security scan completed"
  jq -r '.Results[].Vulnerabilities[] | select(.Severity == "CRITICAL" or .Severity == "HIGH") | "  - \(.VulnerabilityID): \(.Title)"' ./validation/reports/security_scan.json | head -5 || echo "  No critical/high vulnerabilities found"
else
  echo "  Security scan not performed"
fi)

## Recommendations
1. Review security findings above
2. Ensure all tests are passing
3. Update dependencies regularly
4. Add comprehensive documentation

---
*Generated by Enterprise Validation Pipeline*
EOREPORT

          # Upload reports as artifact
          echo "Report saved to ./validation/reports/validation_report.md"

      - name: Upload Validation Reports
        uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: |
            ./validation/reports/
            !./validation/reports/node_modules/
          retention-days: 30

      - name: Security Analysis
        uses: github/codeql-action/analyze@v3

      - name: Dependency Review
        uses: actions/dependency-review-action@v3

  notify:
    runs-on: ubuntu-latest
    needs: validate
    if: always()

    steps:
      - name: Notify on Failure
        if: failure()
        run: |
          echo "Validation failed! Please check the validation reports."
          # Add Slack/Teams notification here
