import streamlit as st

# Sovereign Session State Initialization
if "status" not in st.session_state:
    st.session_state.status = "SOVEREIGN_ACTIVE"
if "trust_index" not in st.session_state:
    st.session_state.trust_index = 97.4
if "battery_level" not in st.session_state:
    st.session_state.battery_level = 85
if "ethical_drift" not in st.session_state:
    st.session_state.ethical_drift = 0.02
from core.app.offline import offline_banner
offline_banner()
apply_layout()
sidebar_status()
loading_guard()

from core.app.ux import loading_guard
from core.app.layout import apply_layout, sidebar_status
from core.runtime.error_guard import guard
from core.ui.state_controller import initialize_sovereign_session; initialize_sovereign_session()
# ------------------------------------------------------------------------------
# Copyright (c) 2025 iLuminara (VISENDI56). All Rights Reserved.
# Licensed under the Polyform Shield License 1.0.0.
# 
# COMPETITOR EXCLUSION: Commercial use by entities offering Sovereign/Health OS 
# solutions is STRICTLY PROHIBITED without a commercial license.
# 
# The Sovereign Immune System (Omni-Law) and JEPA-MPC Architecture are 
# proprietary inventions of iLuminara.
# ------------------------------------------------------------------------------

import streamlit as st
from infrastructure.logistics.cuopt_agent import AgenticDispatcher
from core.jepa_architecture.mpc_controller import EnergyBasedMPC
from core.reasoning.tiny_recursive import TinyRecursiveModel

st.set_page_config(page_title="Logistics Command", layout="wide")
st.title("üöÅ Autonomous Logistics Command (JEPA-TRM Active)")

# 1. State: MPC Status
mpc = EnergyBasedMPC() # Uses TRM internally now
st.sidebar.info("Controller: Energy-Based MPC")
st.sidebar.success("World Model: Tiny Recursive (7M)")

col1, col2 = st.columns([2, 1])

with col1:
    st.markdown("### üó∫Ô∏è Live Operations Map")
    st.image("https://upload.wikimedia.org/wikipedia/commons/thumb/e/ec/Dadaab_refugee_camp_map.jpg/640px-Dadaab_refugee_camp_map.jpg", caption="Dadaab Sector 4 (Simulated Vector Tiles)")

    with col2:
        st.subheader("Agentic Dispatch")
        cmd = st.text_input("Voice Command", placeholder="e.g., 'Reroute Fleet Alpha to Sector 4'")
        
        if cmd:
            # REAL BACKEND CALL
            with st.spinner("TRM Reasoning (16 recursions)..."):
                # 1. TRM plans trajectory
                plan = mpc.plan_trajectory(cmd)
                
                # 2. cuOpt executes
                agent = AgenticDispatcher()
                response = agent.parse_command(cmd)
                
                st.success(f"Plan: {plan}")
                st.info(f"Execution: {response['route_update']}")
                st.json({"Energy_Cost": "0.14J", "Recursion_Depth": 16})