from core.ui.state_controller import initialize_sovereign_session; initialize_sovereign_session()
import streamlit as st
import pandas as pd
import time
from core.rsa_kernel.benchmarks.swe_bench_loader import SovereignBenchmarker

st.set_page_config(page_title="RSA Neural Dojo", page_icon="ðŸ§ ", layout="wide")

# Custom CSS for Terminal Feel
st.markdown("""
    <style>
        .stCode { font-family: 'Courier New', monospace; }
            .stAlert { border-left: 5px solid #00FF00; }
                </style>
                """, unsafe_allow_html=True)

st.title("ðŸ§  RSA: The Cognitive Spiral")
st.caption("System-2 Recursive Reasoning Engine (SWE-Bench Pro)")

# Initialize Benchmarker
if 'bench' not in st.session_state:
    st.session_state.bench = SovereignBenchmarker()

    # Top Metrics
    col1, col2, col3 = st.columns(3)
    with col1:
        st.metric("Reasoning Depth", "Lvl 3", "Recursive")
        with col2:
            st.metric("Pass@1 (Commerical)", "86.8%", "+2.4%")
            with col3:
                st.metric("Experience Replay", "Active", "Learning")

                st.divider()

                # The Battle Arena
                c_left, c_right = st.columns([1, 2])

                with c_left:
                    st.subheader("ðŸ“¡ Training Feed")
                    if st.button("Inject Chaos (New Challenge)", use_container_width=True):
                                st.session_state.challenge = st.session_state.bench.fetch_challenge()
                                        st.session_state.solving = True

                                    if 'challenge' in st.session_state:
                                            st.info(f"**Repo:** {st.session_state.challenge['repo']}")
                                                    st.warning(f"**Issue:** {st.session_state.challenge['id']}")
                                                            with st.expander("View Vector Space (Problem Context)", expanded=True):
                                                                    st.code(st.session_state.challenge['desc'][:250] + "...", language="text")

                                                                    with c_right:
                                                                        st.subheader("ðŸ§¬ Cognitive Spiral Trace")
                                                                            
                                                                                if st.session_state.get('solving', False):
                                                                                        trace_container = st.container()
                                                                                                
                                                                                                        # Execute the Generator
                                                                                                                solver_gen = st.session_state.bench.recursive_solve(st.session_state.challenge)
                                                                                                                        
                                                                                                                                        for step in solver_gen:
                                                                                                                                                    with trace_container:
                                                                                                                                                                    with st.chat_message("assistant", avatar="ðŸ¤–"):
                                                                                                                                                                                        st.write(f"**Spiral Depth {step['depth']}**: {step['action']}")
                                                                                                                                                                                                            col_a, col_b = st.columns(2)
                                                                                                                                                                                                                                col_a.write(f"Confidence: `{step['confidence']}`")
                                                                                                                                                                                                                                                    col_b.write(f"Z3-Gate: `{step['z3_check']}`")
                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                    if step['status'] == "REFACTORING":
                                                                                                                                                                                                                                                                                    st.progress(step['depth'] * 30, text="Critiquing & Refactoring...")
                                                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                                                            st.success("âœ… SOLUTION CONVERGED")
                                                                                                                                                                                                                                                                                                                            st.balloons()
                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                            st.session_state.solving = False

                                                                                                                                                                                                                                                                                                                                                            # Historical Wins (Experience Replay)
                                                                                                                                                                                                                                                                                                                                                            st.divider()
                                                                                                                                                                                                                                                                                                                                                            st.subheader("ðŸ’¾ Experience Replay (Long-Term Memory)")
                                                                                                                                                                                                                                                                                                                                                            try:
                                                                                                                                                                                                                                                                                                                                                                df = pd.read_json("core/rsa_kernel/benchmarks/neural_memory.json")
                                                                                                                                                                                                                                                                                                                                                                    if not df.empty:
                                                                                                                                                                                                                                                                                                                                                                                st.dataframe(df.sort_values("timestamp", ascending=False), use_container_width=True)
                                                                                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                                                                                        st.caption("Memory is empty. Initialize training.")
                                                                                                                                                                                                                                                                                                                                                                                                                except:
                                                                                                                                                                                                                                                                                                                                                                                                                    st.caption("Memory initialization pending...")